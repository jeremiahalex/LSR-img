{"version":3,"file":"lsr-img.js","sources":["../src/lsr-img.js"],"sourcesContent":["/* ===========================================================\n * lsr-img.js v0.1\n * http://jeremiahalex.github.com\n *\n * Web previewer for Apple's Layer Source Representation (LSR) Image format.\n * Requires\n * - JSZip\n *\n * ===========================================================\n * Copyright 2015 Jeremiah Alexander (@JeremiahAlex)\n *\n * Licensed under the MIT license.\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n * ========================================================== */\nimport { version } from '../package.json';\nimport JSZip from 'jszip';\nimport highlightImage from './statics/lsr-highlight.png';\nimport damagedImageSrc from './statics/broken_file.svg';\n\nlet falsy = /^(?:f(?:alse)?|no?|0+)$/i;\n\nfunction isTrue (value) {\n  return !falsy.test(value) && !!value;\n}\n\nfunction getWidth (element) {\n  return element.getBoundingClientRect().width > 0 ?\n    element.getBoundingClientRect().width :\n    parseInt(window.getComputedStyle(element).width);\n}\n\nfunction getHeight (element) {\n  return element.getBoundingClientRect().height > 0 ?\n    element.getBoundingClientRect().height :\n    parseInt(window.getComputedStyle(element).height);\n}\n\nexport function LSRImg (loadOnDemand = false) {\n\n  let lsrImages = [];\n  let lsrImgElements = [];\n  let lsrHighlightImagePath = null;\n  let focussedLsrCanvas = null;\n  let lsrHighlightImage = highlightImage;\n  let lsrShadowPadding = 50;\n  let lsrFocussedPadding = 35;\n  let lsrResizeTimer;\n  let lsrMinAngleX = -10;\n  let lsrMinAngleY = -10;\n  let lsrAngleYCorrector = 1;\n  let lsrAngleRange = 20;\n  let lsrDeviceOrientation = null;\n  let lsrAxisTable = {\n    landscape: {\n      x: 'gamma', y: 'beta', z: 'alpha',\n    }, landscapeInverse: {\n      x: 'gamma', y: 'beta', z: 'alpha',\n    }, portrait: {\n      x: 'beta', y: 'gamma', z: 'alpha',\n    },\n  };\n  let onloadCallback = emptyOnload;\n  let onerrorCallback = emptyOnerror;\n\n  function emptyOnload () {}\n  function emptyOnerror () {}\n\n\n  /*------------------------------\n    Initialize -\n  ------------------------------*/\n  // create a highlight image\n  if (lsrHighlightImagePath !== null) {\n    lsrHighlightImage = new Image();\n    lsrHighlightImage.src = lsrHighlightImagePath;\n  }\n\n  // check if device rotation is supported\n  if (window.DeviceOrientationEvent) {\n    window.addEventListener('orientationchange', lsrOrientationChange, false);\n    window.addEventListener('deviceorientation', lsrOrientationUpdate, false);\n  }\n\n  // catch resize events but not too often\n  window.onresize = function () {\n    if (lsrResizeTimer) {\n      clearTimeout(lsrResizeTimer);\n    }\n    lsrResizeTimer = setTimeout(resizeLSRCanvases, 500);\n  };\n\n  if (!loadOnDemand) {\n    document.onreadystatechange = function () {\n      if (document.readyState === 'complete') {\n        let lsrImgElements = document.getElementsByClassName('lsr-img');\n        for (let lsrImgElement of lsrImgElements) {\n          loadLSRFile(lsrImgElement);\n        }\n      }\n    };\n  }\n\n  function load (elementOrId) {\n    if (loadOnDemand) {\n      if (typeof elementOrId === 'string') {\n        let lsrElement = document.getElementById(elementOrId);\n        if (lsrElement !== null) {\n          elementOrId = lsrElement;\n        } else {\n          throw `LSR-img: the element identified with ID: ${elementOrId}, was not found.`;\n        }\n      }\n\n      if (lsrImgElements.indexOf(elementOrId) !== -1) {\n        removeLsrImage(elementOrId);\n      }\n      else {\n        lsrImgElements.push(elementOrId);\n      }\n\n      loadLSRFile(elementOrId);\n    } else {\n      console.log('LSR-img: load on demand is disable.');\n    }\n  }\n\n  function resizeLSRCanvases () {\n    for (let i = 0; i < lsrImages.length; i++) {\n      if (lsrImages[i].responsive && lsrImages[i].canvas.parentElement.getBoundingClientRect().width > 0 &&\n        lsrImages[i].canvas.parentElement.getBoundingClientRect().height > 0\n      ) {\n        resizeLSRCanvas(lsrImages[i]);\n      }\n    }\n  }\n\n  function resizeLSRCanvas (lsrImage) {\n    let ratio = lsrImage.canvasSize.width / lsrImage.canvasSize.height;\n\n    //we scale the css, so we don't need to redo the canvas content\n    lsrImage.canvas.style.width = getWidth(lsrImage.canvas.parentElement) + 'px';\n    lsrImage.canvas.style.height = (getWidth(lsrImage.canvas.parentElement) / ratio) + 'px';\n  }\n\n  /*------------------------------\n    File Loading -\n  ------------------------------*/\n  function loadLSRFile (element) {\n    try {\n      //grab the lsr-image name from the div\n      let dataAttribute = element.dataset.imageSrc;\n      if (dataAttribute !== null) {\n        let filename = String(dataAttribute);\n\n        //if the filename isn't absolute then, take the window's location for the relative path\n        if (filename.indexOf('http') === -1) {\n          let filePath = String(window.location);\n          filePath = filePath.substr(0, filePath.lastIndexOf('/') + 1);\n          filename = filePath + filename;\n        }\n\n        let xhr = new XMLHttpRequest();\n        xhr.open('GET', filename, true);\n        xhr.responseType = 'blob';\n        xhr.onload = function () {\n          if (this.status === 200) {\n            let fileBlob = new Blob([this.response], {type: 'application/zip'});\n            unzipLSRFile(fileBlob)\n              .then((lsrImage) => {\n                //obtain the settings for this image\n                dataAttribute = element.dataset.rounded;\n                if (typeof dataAttribute === 'undefined') lsrImage.roundedCorners =\n                  false; else lsrImage.roundedCorners =\n                  isTrue(dataAttribute);\n                //shadows\n                dataAttribute = element.dataset.shadows;\n                if (typeof dataAttribute === 'undefined') lsrImage.drawShadows = true; else lsrImage.drawShadows =\n                  isTrue(dataAttribute);\n                //animate\n                dataAttribute = element.dataset.animate;\n                if (typeof dataAttribute === 'undefined') lsrImage.animate = false; else lsrImage.animate =\n                  isTrue(dataAttribute);\n                //focussed\n                dataAttribute = element.dataset.zoom;\n                if (typeof dataAttribute === 'undefined') lsrImage.zoomEnabled = true; else lsrImage.zoomEnabled =\n                  isTrue(dataAttribute);\n                //responsive\n                dataAttribute = element.dataset.responsive;\n                if (typeof dataAttribute === 'undefined') lsrImage.responsive = false; else lsrImage.responsive =\n                  isTrue(dataAttribute);\n\n                //display the image\n                displayLSRImage(lsrImage, element);\n                onloadCallback();\n              })\n              .catch(error => {\n                drawDamagedImage(element);\n                onerrorCallback(error);\n              });\n          }\n        };\n        xhr.onreadystatechange = () => {\n          if (xhr.readyState === XMLHttpRequest.DONE) {\n            if (xhr.status !== 200) {\n              drawDamagedImage(element);\n              onerrorCallback(new Error(`LSR-img: The following LSR file could not be loaded: ${filename}`));\n            }\n          }\n        };\n\n        xhr.send();\n      } else {\n        drawDamagedImage(element);\n        onerrorCallback(new Error('LSR-img: data-image-src attribute not found on lsr-img classed object'));\n      }\n    } catch (error) {\n      drawDamagedImage(element);\n      onerrorCallback(error);\n    }\n  }\n\n  function unzipLSRFile (blob) {\n    return JSZip.loadAsync(blob)\n      .then((zip) => {\n        //find out the lsr file content\n        return zip.file('Contents.json').async('string')\n          .then((content) => {\n            let lsrImage = JSON.parse(content);\n            let openImages = new Array(lsrImage.layers.length);\n            for (let i = 0; i < lsrImage.layers.length; i++) {\n              openImages[i] = openLSRLayer(lsrImage.layers[i], zip);\n            }\n            return Promise.all(openImages)\n              .then(() => {\n                lsrImages.push(lsrImage);\n                return Promise.resolve(lsrImage);\n              });\n          });\n      });\n  }\n\n  function openLSRLayer (lsrImageLayer, zip) {\n    return zip.file(lsrImageLayer.filename + '/Contents.json').async('string')\n      .then((content) => {\n        let json = JSON.parse(content);\n        lsrImageLayer.info = json.info;\n        lsrImageLayer.properties = json.properties;\n        return openLSRImageSet(lsrImageLayer, zip);\n      });\n  }\n\n  function openLSRImageSet (lsrImageLayer, zip) {\n    let entryName = lsrImageLayer.filename + '/Content.imageset/Contents.json';\n    return zip.file(entryName).async('string')\n      .then((content) => {\n        let json = JSON.parse(content);\n        lsrImageLayer.images = json.images;\n        //currently only one image set available\n        if (lsrImageLayer.images.length > 0) {\n          return openImage(lsrImageLayer.images[0],\n            lsrImageLayer.filename + '/Content.imageset/' + lsrImageLayer.images[0].filename, zip);\n        } else {\n          return Promise.reject(new Error(`LSR-img: No Images specified in the layer: ${entryName}`));\n        }\n      });\n  }\n\n  function openImage (lsrLayerImage, entryName, zip) {\n    let ext = entryName.substr(entryName.lastIndexOf('.') + 1);\n    if (ext.match(/(jpg|jpeg|png|gif)$/)) {\n      let mimeType = 'image/' + ext;\n      return zip.file(entryName).async('base64')\n        .then((content) => {\n          lsrLayerImage.fileData = 'data:' + mimeType + ';base64,' + content;\n        });\n    } else {\n      return Promise.reject(new Error(`LSR-img: Layered Image had an unsupported File Type: ${entryName}`));\n    }\n  }\n\n  /*------------------------------\n    Image Display -\n  ------------------------------*/\n  function displayLSRImage (lsrImage, element) {\n    lsrImage.canvasResizeRatio = 1.0;\n    if (lsrImage.responsive) {\n      let wRatio = lsrImage.properties.canvasSize.width / getWidth(element);\n      let hRatio = lsrImage.properties.canvasSize.height / getHeight(element);\n      lsrImage.canvasResizeRatio = wRatio > hRatio ? wRatio : hRatio;\n    }\n\n    //for rendering we add padding to the canvas size for shadows and centering on focus\n    lsrImage.canvasSize = {\n      width: lsrImage.properties.canvasSize.width + (lsrShadowPadding * 2 * lsrImage.canvasResizeRatio),\n      height: lsrImage.properties.canvasSize.height + (lsrShadowPadding * 2 * lsrImage.canvasResizeRatio),\n    };\n\n    let canvas = document.createElement('canvas');\n    canvas.setAttribute('class', 'lsr-canvas');\n    canvas.setAttribute('width', lsrImage.canvasSize.width / lsrImage.canvasResizeRatio);\n    canvas.setAttribute('height', lsrImage.canvasSize.height / lsrImage.canvasResizeRatio);\n    lsrImage.canvas = canvas;\n\n    //create a canvas to render the shadow on\n    let shadowCanvas = document.createElement('canvas');\n    shadowCanvas.setAttribute('width', lsrImage.canvasSize.width / lsrImage.canvasResizeRatio);\n    shadowCanvas.setAttribute('height', lsrImage.canvasSize.height / lsrImage.canvasResizeRatio);\n    lsrImage.shadowCanvas = shadowCanvas;\n    lsrImage.shadowCtx = lsrImage.shadowCanvas.getContext('2d');\n\n    lsrImage.properties.canvasCentre = {};\n    lsrImage.properties.canvasCentre.x = lsrImage.properties.canvasSize.width * 0.5;\n    lsrImage.properties.canvasCentre.y = lsrImage.properties.canvasSize.height * 0.5;\n\n    lsrImage.focussedSize = {};\n    lsrImage.unfocussedSize = {};\n    let unfocusedReduction = lsrFocussedPadding * 2;\n    let aspectRatio = lsrImage.properties.canvasSize.width / lsrImage.properties.canvasSize.height;\n    if (lsrImage.properties.canvasSize.width > lsrImage.properties.canvasSize.height) {\n      lsrImage.focussedSize.width = lsrImage.properties.canvasSize.width / 1.06;\n      lsrImage.unfocussedSize.width = lsrImage.focussedSize.width - unfocusedReduction;\n\n      lsrImage.focussedSize.height = lsrImage.focussedSize.width / aspectRatio;\n      lsrImage.unfocussedSize.height = lsrImage.unfocussedSize.width / aspectRatio;\n      lsrImage.focussedScale = 1 / lsrImage.properties.canvasSize.width * lsrImage.focussedSize.width;\n      lsrImage.unfocussedScale = 1 / lsrImage.properties.canvasSize.width * lsrImage.unfocussedSize.width;\n    } else {\n      lsrImage.focussedSize.height = lsrImage.properties.canvasSize.height / 1.06;\n      lsrImage.unfocussedSize.height = lsrImage.focussedSize.height - unfocusedReduction;\n\n      lsrImage.focussedSize.width = lsrImage.focussedSize.height * aspectRatio;\n      lsrImage.unfocussedSize.width = lsrImage.unfocussedSize.height * aspectRatio;\n      lsrImage.focussedScale = 1 / lsrImage.properties.canvasSize.height * lsrImage.focussedSize.height;\n      lsrImage.unfocussedScale = 1 / lsrImage.properties.canvasSize.height * lsrImage.unfocussedSize.height;\n    }\n    lsrImage.focussedOffset = {};\n    lsrImage.focussedOffset.x = (lsrImage.canvasSize.width - lsrImage.focussedSize.width) * 0.5;\n    lsrImage.focussedOffset.y = (lsrImage.canvasSize.height - lsrImage.focussedSize.height) * 0.5;\n    lsrImage.unfocussedOffset = {};\n    lsrImage.unfocussedOffset.x = (lsrImage.canvasSize.width - lsrImage.unfocussedSize.width) * 0.5;\n    lsrImage.unfocussedOffset.y = (lsrImage.canvasSize.height - lsrImage.unfocussedSize.height) * 0.5;\n\n    lsrImage.ctx = lsrImage.canvas.getContext('2d');\n\n    let loadCount = 0;\n    for (let i = 0; i < lsrImage.layers.length; i++) {\n      let img = new Image();\n      lsrImage.layers[i].img = img;\n      img.onload = function () {\n        ++loadCount;\n        if (loadCount === lsrImage.layers.length) {\n\n          //hide the placeholder image now that we have our canvas\n          element.appendChild(lsrImage.canvas);\n          drawLSRImage(lsrImage, 0, 0);\n          for (let placeholder of element.getElementsByClassName('lsr-placeholder')) {\n            placeholder.style.display = 'none';\n          }\n          if (lsrImage.responsive) resizeLSRCanvas(lsrImage);\n          if (lsrImage.animate) animateLSRImage((new Date()).getTime(), lsrImage);\n        }\n      };\n      //for now all LSR images only have 1 image per layer, so load index 0\n      img.src = lsrImage.layers[i].images[0].fileData;\n    }\n\n    if (!lsrImage.animate) {\n      lsrImage.canvas.onmouseenter = function () {\n        if (!lsrImage.focussed) {\n          lsrImage.focussed = true;\n          if (focussedLsrCanvas !== null) {\n            focussedLsrCanvas.focussed = false;\n            drawLSRImage(focussedLsrCanvas, 0, 0);\n            resetLSRCanvasRotation(focussedLsrCanvas);\n            focussedLsrCanvas.canvas.removeEventListener('mousemove', mouseMoveOverFocusedLSRImage);\n          }\n          focussedLsrCanvas = lsrImage;\n          focussedLsrCanvas.canvas.onmousemove = mouseMoveOverFocusedLSRImage;\n\n          drawLSRImage(lsrImage, 0, 0);\n        }\n      };\n      lsrImage.canvas.onmouseleave = function () {\n        if (lsrImage.focussed) {\n          focussedLsrCanvas = null;\n          lsrImage.focussed = false;\n          lsrImage.canvas.removeEventListener('mousemove', mouseMoveOverFocusedLSRImage);\n\n          drawLSRImage(lsrImage, 0, 0);\n          resetLSRCanvasRotation(lsrImage);\n        }\n      };\n\n      if (window.DeviceOrientationEvent) {\n        //make it auto focussed for now by disabling zoom. in the future we could extend to be based on scroll visability\n        lsrImage.zoomEnabled = false;\n      }\n    }\n  }\n\n  let requestLSRAnimFrame = (function () {\n    return window.requestAnimationFrame ||\n      window.webkitRequestAnimationFrame ||\n      window.mozRequestAnimationFrame ||\n      window.oRequestAnimationFrame ||\n      window.msRequestAnimationFrame ||\n      function (callback) {\n        window.setTimeout(callback, 1000 / 60);\n      };\n  })();\n\n  function animateLSRImage (startTime, lsrImage) {\n    if (!lsrImage.focussed) lsrImage.focussed = true;\n\n    let time = (new Date()).getTime() - startTime;\n\n    // let speed = 500;\n    let theta = time / 500;\n\n    let relX = Math.cos(theta);\n    let relY = Math.sin(theta);\n\n    //TODO- there is duplication across a few of used thse poisitioning functions, so they should be a refactored\n    let rotateAroundX = -relX;\n    let rotateAroundY = relY;\n\n    let panX = -relX;\n    let panY = relY;\n\n    drawLSRImage(lsrImage, panX, panY);\n    rotateLSRCanvas(lsrImage, rotateAroundX, rotateAroundY);\n\n    requestLSRAnimFrame(function () {\n      animateLSRImage(startTime, lsrImage);\n    });\n  }\n\n  function resetLSRCanvasRotation (lsrImage) {\n    rotateLSRCanvas(lsrImage, 0, 0);\n  }\n\n  function lsrClamp (val, min, max) {\n    if (val > max) return max;\n    if (val < min) return min;\n    return val;\n  }\n\n  function lsrOrientationChange () {\n    if (window.orientation === 0) {\n      lsrDeviceOrientation = 'portrait';\n      lsrAngleRange = 20;\n      lsrMinAngleY = -10;\n    } else {\n      //less rotation on landscape\n      lsrDeviceOrientation = window.orientation === -90 ? 'landscapeInverse' : 'landscape';\n      lsrAngleRange = 10;\n      lsrMinAngleY = -5;\n    }\n\n    lsrMinAngleX = window.orientation === 90 ? lsrMinAngleY - 45 : lsrMinAngleY + 45;\n    lsrAngleYCorrector = window.orientation === -90 ? -1 : 1;\n  }\n\n  function lsrOrientationUpdate (e) {\n    if (lsrDeviceOrientation == null) lsrOrientationChange(null);\n\n    let x = e[lsrAxisTable[lsrDeviceOrientation].x];\n    let y = e[lsrAxisTable[lsrDeviceOrientation].y] * lsrAngleYCorrector;\n\n    let relX = lsrClamp((x - lsrMinAngleX) / lsrAngleRange, 0, 1);\n    let relY = lsrClamp((y - lsrMinAngleY) / lsrAngleRange, 0, 1);\n\n    let rotateAroundX = relX * 2 - 1;\n    let rotateAroundY = relY * 2 - 1;\n    let panX = relY * 2 - 1;\n    let panY = relX * 2 - 1;\n\n    for (let n = 0; n < lsrImages.length; n++) {\n      drawLSRImage(lsrImages[n], panX, panY);\n      rotateLSRCanvas(lsrImages[n], -rotateAroundX, rotateAroundY);\n    }\n  }\n\n  function mouseMoveOverFocusedLSRImage (e) {\n    let parentRect = focussedLsrCanvas.canvas.getBoundingClientRect();\n    let relX = e.pageX - parentRect.left;\n    let relY = e.pageY - parentRect.top;\n\n    relX = 1 / parentRect.width * relX;\n    relY = 1 / parentRect.height * relY;\n\n    let rotateAroundX = relY * 2 - 1;\n    let rotateAroundY = relX * 2 - 1;\n\n    let panX = 1 - relX * 2;\n    let panY = 1 - relY * 2;\n\n    drawLSRImage(focussedLsrCanvas, panX, panY);\n    rotateLSRCanvas(focussedLsrCanvas, rotateAroundX, -rotateAroundY);\n  }\n\n  function rotateLSRCanvas (lsrImage, degreeX, degreeY) {\n    let perspective = 0;\n\n    if (degreeX !== 0 || degreeY !== 0) perspective = 1000;\n\n    degreeX *= 3;\n    degreeY *= 3;\n\n    let parentCSS = lsrImage.canvas.parentElement.style;\n    parentCSS['-webkit-perspective'] = perspective + 'px';\n    parentCSS['-moz-perspective'] = perspective + 'px';\n    parentCSS['-ms-perspective'] = perspective + 'px';\n    parentCSS['-o-perspective'] = perspective + 'px';\n    parentCSS['-perspective'] = perspective + 'px';\n\n    let canvasCSS = lsrImage.canvas.style;\n    canvasCSS['-webkit-transform'] = ' rotateY(' + degreeY + 'deg)' + ' rotateX(' + degreeX + 'deg)';\n    canvasCSS['-moz-transform'] = ' rotateY(' + degreeY + 'deg)' + ' rotateX(' + degreeX + 'deg)';\n    canvasCSS['-ms-transform'] = ' rotateY(' + degreeY + 'deg)' + ' rotateX(' + degreeX + 'deg)';\n    canvasCSS['-o-transform'] = ' rotateY(' + degreeY + 'deg)' + ' rotateX(' + degreeX + 'deg)';\n    canvasCSS['-transform'] = ' rotateY(' + degreeY + 'deg)' + ' rotateX(' + degreeX + 'deg)';\n  }\n\n  //TODO. lots of opportunity for optimisation in this function\n  function drawLSRImage (lsrImage, relX, relY) {\n    lsrImage.ctx.clearRect(0, 0, lsrImage.canvasSize.width / lsrImage.canvasResizeRatio,\n      lsrImage.canvasSize.height / lsrImage.canvasResizeRatio);\n    lsrImage.ctx.globalCompositeOperation = 'source-over';\n\n    let focusScale;\n    let focusOffset = {};\n    if (lsrImage.focussed || !lsrImage.zoomEnabled) {\n      focusScale = lsrImage.focussedScale;\n      focusOffset.x = lsrImage.focussedOffset.x;\n      focusOffset.y = lsrImage.focussedOffset.y;\n    } else {\n      focusScale = lsrImage.unfocussedScale;\n      focusOffset.x = lsrImage.unfocussedOffset.x;\n      focusOffset.y = lsrImage.unfocussedOffset.y;\n    }\n\n    let max = lsrImage.layers.length - 1;\n    let scalePerLayer = 0.06 / max;\n\n    // TODO: turning off image smoothing sharpens the image but creates lines in animation and poor resuls when scaling, to invesitgate\n    // lsrImage.ctx.mozImageSmoothingEnabled = false;\n    // lsrImage.ctx.webkitImageSmoothingEnabled = false;\n    // lsrImage.ctx.msImageSmoothingEnabled = false;\n    // lsrImage.ctx.imageSmoothingEnabled = false;\n\n    for (let i = max; i >= 0; --i) {\n      let x = focusOffset.x, y = focusOffset.y;\n      let sizeScale = focusScale;\n\n      //TODO. the default value should probably be calculated as a proportion of the width/height or padding\n      let panOffset = {x: relX * 15, y: relY * 10};\n\n      //increase the scale for each layer\n      if (lsrImage.focussed || !lsrImage.zoomEnabled) sizeScale += (max - i) * scalePerLayer;\n\n      let width = lsrImage.layers[i].properties['frame-size'].width * sizeScale;\n      let height = lsrImage.layers[i].properties['frame-size'].height * sizeScale;\n\n      if (typeof lsrImage.layers[i].properties['frame-center'] !== 'undefined') {\n        x += lsrImage.layers[i].properties['frame-center'].x * focusScale;\n        y += lsrImage.layers[i].properties['frame-center'].y * focusScale;\n      } else {\n        x += lsrImage.properties.canvasCentre.x * focusScale;\n        y += lsrImage.properties.canvasCentre.y * focusScale;\n      }\n\n      //as we move up the layers the further from the center, the more pronounced the move\n      if (lsrImage.focussed || !lsrImage.zoomEnabled) {\n        let distfromCenter = {\n          x: lsrImage.properties.canvasCentre.x - lsrImage.layers[i].properties['frame-center'].x,\n          y: lsrImage.properties.canvasCentre.y - lsrImage.layers[i].properties['frame-center'].y,\n        };\n\n        //TODO. these numbers seem to work, would be good to have a better rationale behind them though\n        x -= distfromCenter.x * 0.03 * (max - i);\n        y -= distfromCenter.y * 0.03 * (max - i);\n\n        panOffset.x += (lsrImage.canvasSize.width * 0.003) * i * relX;\n        panOffset.y += (lsrImage.canvasSize.width * 0.003) * i * relY;\n      }\n\n      // adjust with the pan\n      x -= width * 0.5 + panOffset.x;\n      y -= height * 0.5 + panOffset.y;\n\n      width /= lsrImage.canvasResizeRatio;\n      height /= lsrImage.canvasResizeRatio;\n      x /= lsrImage.canvasResizeRatio;\n      y /= lsrImage.canvasResizeRatio;\n\n      lsrImage.ctx.drawImage(lsrImage.layers[i].img, x, y, width, height);\n    }\n\n    // calculate baseRect take into account the lsrImage.canvasSize.\n    let panOffset = {x: relX * 15, y: relY * 10};\n    if (lsrImage.focussed || !lsrImage.zoomEnabled) {\n      panOffset.x += (lsrImage.canvasSize.width * 0.003) * max * relX;\n      panOffset.y += (lsrImage.canvasSize.width * 0.003) * max * relY;\n    }\n    let baseRect = {};\n    baseRect.width = lsrImage.properties.canvasSize.width * focusScale;\n    baseRect.height = lsrImage.properties.canvasSize.height * focusScale;\n    baseRect.x =\n      focusOffset.x + (lsrImage.properties.canvasCentre.x * focusScale) - (baseRect.width * 0.5 + panOffset.x);\n    baseRect.y =\n      focusOffset.y + (lsrImage.properties.canvasCentre.y * focusScale) - (baseRect.height * 0.5 + panOffset.y);\n    baseRect.width /= lsrImage.canvasResizeRatio;\n    baseRect.height /= lsrImage.canvasResizeRatio;\n    baseRect.x /= lsrImage.canvasResizeRatio;\n    baseRect.y /= lsrImage.canvasResizeRatio;\n\n    //add the highlight\n    if (lsrHighlightImage !== null && (lsrImage.focussed || !lsrImage.zoomEnabled)) {\n      let x = lsrImage.focussedSize.width * ((1 - relX) * 0.5) - lsrImage.focussedSize.width * 0.5;\n      let y = lsrImage.focussedSize.height * ((1 - relY) * 0.5) - lsrImage.focussedSize.width * 0.6;\n      lsrImage.ctx.drawImage(\n        lsrHighlightImage,\n        x / lsrImage.canvasResizeRatio,\n        y / lsrImage.canvasResizeRatio,\n        lsrImage.focussedSize.width / lsrImage.canvasResizeRatio,\n        lsrImage.focussedSize.width / lsrImage.canvasResizeRatio);\n    }\n\n    //finally we draw our frame and crop\n    if (lsrImage.roundedCorners) {\n      let radius = 10;\n      lsrImage.ctx.fillStyle = '#fff';\n      lsrImage.ctx.globalCompositeOperation = 'destination-in';\n      lsrImage.ctx.beginPath();\n      lsrImage.ctx.moveTo(baseRect.x + radius, baseRect.y);\n      lsrImage.ctx.lineTo(baseRect.x + baseRect.width - radius, baseRect.y);\n      lsrImage.ctx.quadraticCurveTo(baseRect.x + baseRect.width, baseRect.y, baseRect.x + baseRect.width,\n        baseRect.y + radius);\n      lsrImage.ctx.lineTo(baseRect.x + baseRect.width, baseRect.y + baseRect.height - radius);\n      lsrImage.ctx.quadraticCurveTo(baseRect.x + baseRect.width, baseRect.y + baseRect.height,\n        baseRect.x + baseRect.width - radius, baseRect.y + baseRect.height);\n      lsrImage.ctx.lineTo(baseRect.x + radius, baseRect.y + baseRect.height);\n      lsrImage.ctx.quadraticCurveTo(baseRect.x, baseRect.y + baseRect.height, baseRect.x,\n        baseRect.y + baseRect.height - radius);\n      lsrImage.ctx.lineTo(baseRect.x, baseRect.y + radius);\n      lsrImage.ctx.quadraticCurveTo(baseRect.x, baseRect.y, baseRect.x + radius, baseRect.y);\n      lsrImage.ctx.closePath();\n      lsrImage.ctx.fill();\n    } else {\n      lsrImage.ctx.fillStyle = '#fff';\n      lsrImage.ctx.globalCompositeOperation = 'destination-in';\n      lsrImage.ctx.beginPath();\n      lsrImage.ctx.rect(baseRect.x, baseRect.y, baseRect.width, baseRect.height);\n      lsrImage.ctx.closePath();\n      lsrImage.ctx.fill();\n    }\n\n    //add some shadows\n    if (lsrImage.drawShadows) {\n      lsrImage.shadowCtx.clearRect(0, 0, lsrImage.canvasSize.width / lsrImage.canvasResizeRatio,\n        lsrImage.canvasSize.height / lsrImage.canvasResizeRatio);\n\n      let indent = 10;\n      let shadowSize = (lsrImage.focussed || !lsrImage.zoomEnabled) ? lsrShadowPadding * 0.5 : lsrShadowPadding * 0.25;\n      lsrImage.shadowCtx.beginPath();\n      lsrImage.shadowCtx.fillStyle = '#000';\n      lsrImage.shadowCtx.rect(baseRect.x + indent * 0.5, baseRect.y + indent * 0.5, baseRect.width - indent,\n        baseRect.height - indent);\n      lsrImage.shadowCtx.shadowBlur = shadowSize;\n      lsrImage.shadowCtx.shadowColor = lsrImage.focussed ? '#666' : '#999';\n      lsrImage.shadowCtx.shadowOffsetX = 0;\n      lsrImage.shadowCtx.shadowOffsetY = (shadowSize * 0.5);\n      lsrImage.shadowCtx.closePath();\n      lsrImage.shadowCtx.fill();\n\n      lsrImage.ctx.globalCompositeOperation = 'destination-over';\n      lsrImage.ctx.drawImage(lsrImage.shadowCanvas, 0, 0);\n    }\n  }\n\n  function removeLsrImage (element) {\n    let index = lsrImages.findIndex(lsrImage => { return lsrImage.canvas.parentElement === element; });\n    if (index !== -1) {\n      element.removeChild(lsrImages[index].canvas);\n      lsrImages.splice(index, 1);\n    }\n  }\n\n  function drawDamagedImage (element) {\n    let damagedImage = damagedImageSrc.cloneNode(true);\n    damagedImage.style.width = '100%';\n    damagedImage.style.height = 'auto';\n    damagedImage.alt = 'Damaged LSR Image';\n    damagedImage.title = 'Damaged LSR Image';\n    element.appendChild(damagedImage);\n    for (let placeholder of element.getElementsByClassName('lsr-placeholder')) {\n      placeholder.style.display = 'none';\n    }\n  }\n\n  return {\n    setHighlightImage: function (imgPath) {\n      lsrHighlightImagePath = imgPath;\n    },\n    load: function (elementOrId) {\n      load(elementOrId);\n    },\n    onload: function (callback) {\n      if (callback !== null && callback !== undefined) {\n        onloadCallback = callback;\n      } else {\n        onloadCallback = emptyOnload;\n      }\n    },\n    onerror: function (callback) {\n      if (callback !== null && callback !== undefined) {\n        onerrorCallback = callback;\n      } else {\n        onerrorCallback = emptyOnerror();\n      }\n    },\n    version: version,\n  };\n\n}\n"],"names":["falsy","isTrue","value","test","getWidth","element","getBoundingClientRect","width","parseInt","window","getComputedStyle","getHeight","height","LSRImg","loadOnDemand","lsrImages","lsrImgElements","lsrHighlightImagePath","focussedLsrCanvas","lsrHighlightImage","highlightImage","lsrShadowPadding","lsrFocussedPadding","lsrResizeTimer","lsrMinAngleX","lsrMinAngleY","lsrAngleYCorrector","lsrAngleRange","lsrDeviceOrientation","lsrAxisTable","landscape","x","y","z","landscapeInverse","portrait","onloadCallback","emptyOnload","onerrorCallback","emptyOnerror","Image","src","DeviceOrientationEvent","addEventListener","lsrOrientationChange","lsrOrientationUpdate","onresize","clearTimeout","setTimeout","resizeLSRCanvases","document","onreadystatechange","readyState","getElementsByClassName","lsrImgElement","loadLSRFile","load","elementOrId","lsrElement","getElementById","indexOf","removeLsrImage","push","console","log","i","length","responsive","canvas","parentElement","resizeLSRCanvas","lsrImage","ratio","canvasSize","style","dataAttribute","dataset","imageSrc","filename","String","filePath","location","substr","lastIndexOf","xhr","XMLHttpRequest","open","responseType","onload","status","fileBlob","Blob","response","type","unzipLSRFile","then","rounded","roundedCorners","shadows","drawShadows","animate","zoom","zoomEnabled","displayLSRImage","catch","drawDamagedImage","error","DONE","Error","send","blob","JSZip","loadAsync","zip","file","async","content","JSON","parse","openImages","Array","layers","openLSRLayer","Promise","all","resolve","lsrImageLayer","json","info","properties","openLSRImageSet","entryName","images","openImage","reject","lsrLayerImage","ext","match","mimeType","fileData","canvasResizeRatio","wRatio","hRatio","createElement","setAttribute","shadowCanvas","shadowCtx","getContext","canvasCentre","focussedSize","unfocussedSize","unfocusedReduction","aspectRatio","focussedScale","unfocussedScale","focussedOffset","unfocussedOffset","ctx","loadCount","img","appendChild","drawLSRImage","placeholder","display","animateLSRImage","Date","getTime","onmouseenter","focussed","resetLSRCanvasRotation","removeEventListener","mouseMoveOverFocusedLSRImage","onmousemove","onmouseleave","requestLSRAnimFrame","requestAnimationFrame","webkitRequestAnimationFrame","mozRequestAnimationFrame","oRequestAnimationFrame","msRequestAnimationFrame","callback","startTime","time","theta","relX","Math","cos","relY","sin","rotateAroundX","rotateAroundY","panX","panY","rotateLSRCanvas","lsrClamp","val","min","max","orientation","e","n","parentRect","pageX","left","pageY","top","degreeX","degreeY","perspective","parentCSS","canvasCSS","clearRect","globalCompositeOperation","focusScale","focusOffset","scalePerLayer","sizeScale","panOffset","distfromCenter","drawImage","baseRect","radius","fillStyle","beginPath","moveTo","lineTo","quadraticCurveTo","closePath","fill","rect","indent","shadowSize","shadowBlur","shadowColor","shadowOffsetX","shadowOffsetY","index","findIndex","removeChild","splice","damagedImage","damagedImageSrc","cloneNode","alt","title","setHighlightImage","imgPath","undefined","onerror","version"],"mappings":"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"}